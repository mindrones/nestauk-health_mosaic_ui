<script>
  import QueryBuilder from '../components/QueryBuilder';
  import { store, state } from '../machines/search';
  //import { querify } from '../util/parse';
  import {subjectFields, contentFields} from '../config';
  import {dslBuilder, createFields} from '../util/parse';

  let currentData,
    value = '';

  function handleChange(input) {
    value = input.detail.filter(v => !!v);
    checkDirty();
  }

  function handleSend(rules) {
    let joinedRules = rules.map(v => ({
      visible: v.visible,
      value: v.value,
      fields: [].concat(
        createFields(contentFields, v.content),
        createFields(subjectFields, v.subject)
      )
    }));

    joinedRules = joinedRules.reduce((acc, next) => {
      if (!next.visible) return acc;
      return  acc + dslBuilder(next.value, next.fields);
    }, '')

    state.send({ type: 'SEARCH', query: joinedRules, value });
  }

  function checkDirty() {
    state.send('CHANGED');

    // if ($store.value !== value.toString()) {
    //   state.send('CHANGED');
    // } else {
    //   state.send('SAME');
    // }
  }
</script>

<div class="search">
  <QueryBuilder
    {subjectFields}
    {contentFields}
    status="{$state.dirty ? 'dirty' : 'clean'}"
    on:change="{ handleChange }"
    send="{ handleSend }" />
</div>


<style>
  .search {
    width: 100%;
  }
</style>
